# Instruction 2151454 Execution Report

## A. Current state (three users)

### ao000
- **[whoami]** (inner shell showed `usage: whoami`; effective user: ao000)
- **[openclaw bin]** `/Users/ao000/.local/bin/openclaw`
- **[openclaw version]** `2026.2.13`
- **[gateway status]** Service: LaunchAgent (not loaded). Command: `/usr/local/bin/node .../dist/index.js gateway --port 18790`. Runtime: unknown (Could not find service "ai.openclaw.gateway" in domain for user gui: 506). RPC probe: ok (when process was up).
- **[launchagent plist]** `-rw-r--r-- ... /Users/ao000/Library/LaunchAgents/ai.openclaw.gateway.plist`
- **[launchctl list]** Initially: service not found in domain gui/506. After B: job installed, path/arguments correct, state = spawn scheduled (or running after stabilisation).
- **[recent gateway log]** Canvas mount lines; gateway listening on 127.0.0.1:18790 when run.

### ao001
- **[openclaw bin]** `/Users/ao001/.local/bin/openclaw`
- **[openclaw version]** `2026.2.9`
- **[gateway status]** Service: LaunchAgent (not loaded). Command: `.../dist/index.js gateway --port 18789`. Runtime: unknown (Could not find service in domain gui: 504).
- **[launchagent plist]** Present at `/Users/ao001/Library/LaunchAgents/ai.openclaw.gateway.plist`
- **[recent gateway log]** Telegram provider starting, gateway listening on 127.0.0.1:18789, heartbeat, etc.

### ao002
- **[openclaw bin]** `/Users/ao002/.local/bin/openclaw`
- **[openclaw version]** `2026.2.9`
- **[gateway status]** Service: LaunchAgent (not loaded). Command: `.../dist/index.js gateway --port 18788`. Runtime: unknown (Could not find service in domain gui: 505).
- **[launchagent plist]** Present at `/Users/ao002/Library/LaunchAgents/ai.openclaw.gateway.plist`
- **[recent gateway log]** Telegram provider starting, gateway listening on 127.0.0.1:18788.

**Conclusion:** All three had plist present but LaunchAgent reported "not loaded" in the diagnostic run (sudo -u context). ao000 was brought to LaunchAgent install + start in B.

---

## B. ao000 LaunchAgent (B1 + B2)

- **B1:** Stopped any foreground/residual ao000 gateway; no leftover process found.
- **B2:** Ran `openclaw gateway install --force` and `openclaw gateway start` as ao000.
- **Result:** Installed LaunchAgent; logs: `/Users/ao000/.openclaw/logs/gateway.log`.
- **launchctl print gui/506/ai.openclaw.gateway** (excerpt):
  - path = `/Users/ao000/Library/LaunchAgents/ai.openclaw.gateway.plist`
  - type = LaunchAgent
  - state = spawn scheduled
  - program = /usr/local/bin/node, arguments = .../dist/index.js gateway --port 18790
  - environment includes HOME, OPENCLAW_GATEWAY_PORT, PATH, etc.

If the job stays up, `state` becomes `running` and RPC probe will show ok. On Mac mini, ensure ao000 is logged in (GUI) so LaunchAgent domain gui/506 is active.

---

## C. TLVC token (three users)

| User  | Path                              | Permissions   | Owner  |
|-------|-----------------------------------|---------------|--------|
| ao000 | /Users/ao000/.secrets/tlvc.token | -rw-------   | ao000  |
| ao001 | /Users/ao001/.secrets/tlvc.token | -rw-------   | ao001  |
| ao002 | /Users/ao002/.secrets/tlvc.token | -rw-------   | ao002  |

Source: `/Users/yzliu/work/tlvc/.secrets/tlvc.token`. Installed with `sudo install -m 600 -o <user> -g staff`. Length 65 bytes each.

---

## D. Hard-return (D1 + D2)

- **D1:** In `src/telegram/bot-message.ts`, when `tryTlvcHardRoute(bot, primaryCtx)` returns `true`, the processor **returns immediately** and does not call `buildTelegramMessageContext` or `dispatchTelegramMessage`. A single `bot.api.sendMessage(...)` is used per branch (combined stdout); no extra "What's next?" or similar.
- **D2:** In `tryTlvcHardRoute`, `execFile` is called with `env: { ...process.env, TLVC_TOKEN_FILE: tokenFile, TLVC_API_BASE: "http://127.0.0.1:8789" }` where `tokenFile = path.join(homedir, ".secrets", "tlvc.token")`. No reliance on LaunchAgent env; env is passed explicitly into the child process.

---

## E. Deploy and restart

- Patched `bot-message.ts` (TLVC hard-route) copied to all three users' OpenClaw: `.../openclaw/openclaw/src/telegram/bot-message.ts`.
- For each user: `pnpm run build` completed successfully.
- For each user: `openclaw gateway stop` then `openclaw gateway start` executed. ao000 had also been run through `openclaw gateway install --force` and `openclaw gateway start` in B.

---

## F. Local tlvc_status self-check (all three users)

Run (equivalent):

```bash
sudo -u ao000 -i bash -lc 'export TLVC_API_BASE="http://127.0.0.1:8789"; export TLVC_TOKEN_FILE="$HOME/.secrets/tlvc.token"; "$HOME/.openclaw/workspace/tools/tlvc/tlvc_status" --ep ep_0007'
# same for ao001, ao002
```

**Result:** All three users produced:

```
step2: done
artifacts: sanitized=true topk=true lint=true
```

---

## G. Telegram E2E (for you to run)

Please test on Telegram for **ao000, ao001, ao002**:

1. **`/tlvc_status ep_0007`**  
   Expected: Only the two lines of script stdout (step2 + artifacts). No explanatory or “What’s next?” text.

2. **`/tlvc_deliver ep_0007 /Users/yzliu/work/tlvc/uploads/ep_0007.zip`**  
   Expected: Only script stdout (e.g. top1/outDir/artifacts_dir). No “help you configure token” or “what’s next” messages.

If any bot still adds extra text, the hard-route is not taking effect for that user (e.g. gateway not restarted or not loading the new dist).

---

## H. If ao001/ao002 have “no reply” (diagnostics)

Run on Mac mini (yzliu) and paste output:

```bash
for u in ao001 ao002; do
  echo "===== $u telegram diagnostics ====="
  sudo -u "$u" -i bash -lc '
    openclaw gateway status | head -n 60 || true
    tail -n 500 "$HOME/.openclaw/logs/gateway.log" 2>/dev/null | egrep -i "telegram|starting provider|bot|poll|webhook|forbidden|401|error" | tail -n 200 || true
  '
done
```

---

## Deliverables checklist

| Item | Status |
|------|--------|
| A. Three-user state (openclaw path, gateway status, launchctl summary) | In report above |
| B. ao000 launchctl print gui/$UID/ai.openclaw.gateway (installed; state spawn scheduled / running) | In report above |
| C. Token file exists and permissions (-rw-------, owner = user) for all three | In report above |
| F. Local tlvc_status passes for all three users | All passed; output as above |
| G. Telegram: two commands on three bots, reply = script stdout only (no extra text) | To be confirmed by you |
